<h2>7. Encrypted Drive Round-Trip Test</h2>
<div class="panel">
  <button id="encDriveUploadBtn">Encrypt & Upload</button>
  <button id="encDriveDownloadBtn">Download & Decrypt</button>
  <div id="encDrive"></div>
</div>

<script>
/* ------------------- Encrypted Drive Round-Trip ------------------- */
let ENC_DRIVE_TEST = {
  fileId: null,
  plaintext: "GIS:ENCRYPTED:POINT(-74.006 40.7128)", // example payload
  salt: "fixed-test-salt",
  iv: null,
  ciphertext: null
};

const encDriveEl = document.getElementById("encDrive");

document.getElementById("encDriveUploadBtn").onclick = async () => {
  encDriveEl.innerHTML = "";
  const btn = document.getElementById("encDriveUploadBtn");
  btn.disabled = true;

  try {
    if(!accessToken) await requestAccessToken();

    // --- Encrypt ---
    const key = await deriveKey("correct horse battery staple", ENC_DRIVE_TEST.salt);
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const cipherBuf = await crypto.subtle.encrypt(
      { name: "AES-GCM", iv },
      key,
      enc.encode(ENC_DRIVE_TEST.plaintext)
    );

    ENC_DRIVE_TEST.iv = iv;
    ENC_DRIVE_TEST.ciphertext = cipherBuf;

    // --- Upload ---
    const blob = new Blob([cipherBuf], { type: "application/octet-stream" });
    const metadata = { name: "crypto-encrypted-roundtrip.bin", mimeType: "application/octet-stream" };
    const form = new FormData();
    form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
    form.append("file", blob);

    const res = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
      method: "POST",
      headers: { "Authorization": "Bearer " + accessToken },
      body: form
    });

    if(!res.ok) { const text=await res.text(); throw new Error(`HTTP ${res.status}: ${text}`); }
    const json = await res.json();
    ENC_DRIVE_TEST.fileId = json.id;

    log(encDriveEl, `Encrypted payload uploaded. File ID: ${json.id}`);
    log(encDriveEl, `<span class="pass">ENCRYPT & UPLOAD OK</span>`);

  } catch(e) {
    log(encDriveEl, `<span class="fail">UPLOAD ERROR: ${e?.message || JSON.stringify(e)}</span>`);
  } finally {
    btn.disabled = false;
  }
};

document.getElementById("encDriveDownloadBtn").onclick = async () => {
  encDriveEl.innerHTML = "";
  const btn = document.getElementById("encDriveDownloadBtn");
  btn.disabled = true;

  try {
    if(!ENC_DRIVE_TEST.fileId) { log(encDriveEl, `<span class="fail">No encrypted file uploaded yet</span>`); return; }
    if(!accessToken) await requestAccessToken();

    const res = await fetch(`https://www.googleapis.com/drive/v3/files/${ENC_DRIVE_TEST.fileId}?alt=media`, {
      headers: { "Authorization": "Bearer " + accessToken }
    });
    if(!res.ok) { const text=await res.text(); throw new Error(`HTTP ${res.status}: ${text}`); }

    const buf = new Uint8Array(await res.arrayBuffer());

    log(encDriveEl, `Downloaded length: ${buf.length}, Encrypted length: ${ENC_DRIVE_TEST.ciphertext.byteLength}`);
    if(buf.length !== ENC_DRIVE_TEST.ciphertext.byteLength) throw new Error("Length mismatch");

    // --- Decrypt ---
    const key = await deriveKey("correct horse battery staple", ENC_DRIVE_TEST.salt);
    const decryptedBuf = await crypto.subtle.decrypt(
      { name: "AES-GCM", iv: ENC_DRIVE_TEST.iv },
      key,
      buf
    );
    const decrypted = dec.decode(decryptedBuf);

    log(encDriveEl, `Decrypted payload: ${decrypted}`);
    log(encDriveEl, decrypted === ENC_DRIVE_TEST.plaintext ? `<span class="pass">DECRYPT & VERIFY PASS</span>` : `<span class="fail">DECRYPT & VERIFY FAIL</span>`);

  } catch(e) {
    log(encDriveEl, `<span class="fail">DOWNLOAD/DECRYPT ERROR: ${e?.message || JSON.stringify(e)}</span>`);
  } finally {
    btn.disabled = false;
  }
};
</script>
